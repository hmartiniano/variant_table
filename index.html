<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Variant Browser</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- PapaParse for robust CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Bundled DataTables CSS (No Cache Busting) -->
    <link href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/fh-4.0.1/r-3.0.4/datatables.min.css" rel="stylesheet" integrity="sha384-JpqQOjIGq/EFVovaJf+WuEY4QMGtpwS4X8vy/ao4Of+uRdrvXtwEF6hw/mgGCFkl" crossorigin="anonymous">

    <style>
        body { font-family: sans-serif; padding: 20px; }
        #variantsTable_wrapper { margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        .dt-layout-row { margin-bottom: 10px; }

        /* Styles for DataTables Buttons */
        .dt-button {
            background-color: #f8f9fa; color: #343a40; border: 1px solid #ced4da;
            padding: 5px 10px; margin: 0 3px; border-radius: 4px; cursor: pointer;
            text-decoration: none; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
            font-size: 0.9em;
        }
        .dt-button:hover { background-color: #e2e6ea; color: #343a40; border-color: #adb5bd; text-decoration: none; }
        .dt-button:focus { outline: none; box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.5); }

        /* --- Minimal CSS for Manual Control Cell --- */
        /* Rely on default DataTables CSS for the ::before indicator */
        table.dataTable td.dt-control {
            cursor: pointer;
            text-align: center;
            user-select: none;
        }
        /* REMOVED all custom ::before styles for dt-control */
        /* --- End Minimal Control CSS --- */


        /* Style for the Expanded Child Row Content */
        .child-details { padding: 5px 0; }
        .child-details dl {
            margin: 10px 0 10px 40px; /* Indent content relative to main row */
            padding: 10px; background-color: #f9f9f9;
            border: 1px solid #eee; border-radius: 4px;
            display: inline-block; width: calc(100% - 50px);
        }
        .child-details dt {
            font-weight: bold; color: #444; float: left; width: 150px;
            clear: left; text-align: right; margin-right: 10px; margin-bottom: 5px;
        }
        .child-details dd { margin-left: 165px; margin-bottom: 5px; word-wrap: break-word; }
        .child-details .no-details { margin-left: 40px; font-style: italic; color: #666; }

        /* Accessibility helper */
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* Genome Browser Link Styling */
        .genome-browser-link { display: inline-block; padding: 2px 5px; text-decoration: none; }
        .genome-browser-link.na { color: #999; cursor: default; }
        .genome-browser-col { text-align: center; }

        /* Loader styles */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }

        .loader-spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-container p {
            margin-top: 15px;
            font-size: 1.2em;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>Genetic Variant Browser</h1>

    <div id="loader" class="loader-container">
        <div class="loader-spinner"></div>
        <p>Loading variants...</p>
    </div>

    <table id="variantsTable" class="display" style="width:100%">
        <thead>
             <!-- Headers generated by JS -->
        </thead>
        <tbody>
            <!-- Body populated by DataTables -->
        </tbody>
    </table>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" integrity="sha384-VFQrHzqBh5qiJIU0uGU5CIW3+OWpdGGJM9LBnGbuIH2mkICcFZ7lPd/AAtI7SNf7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" integrity="sha384-/RlQG9uf0M2vcTw3CX7fbqgbj/h8wKxw7C3zu9/GxcBPRKOEcESxaxufwRXqzq6n" crossorigin="anonymous"></script>
    <!-- Bundled DataTables JS (No Cache Busting) -->
    <script src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/fh-4.0.1/r-3.0.4/datatables.min.js" integrity="sha384-H25aM0TT5Q3rZAskYnl0FH73D0d7HzcDC6PsYDSrrBTtzAJ2AmTW+nTvV9MhzL5H" crossorigin="anonymous"></script>

    <script>
        // --- IIFE to encapsulate scope ---
        (function() {

            // --- Configuration Object ---
            const config = {
                useCsvData: true,
                csvFilePath: 'variants.csv',
                mainTableKeys: ['gene', 'variantId', 'clinvarId', 'chromosome', 'position', 'clinicalSignificance'],
                showMainKeysInChildRow: false,
                genomeBrowserBaseUrl: 'https://www.ncbi.nlm.nih.gov/genome/gdv/browser/?context=genome',
                genomeAssembly: 'GCF_000001405.38'
            };

            // --- Sample Genetic Variant Data (Fallback) ---
            const dataFromJs = [ /* ... sample data ... */
                 { gene: 'BRCA1', variantId: 'rs1799966', clinvarId: 17217, chromosome: '17', position: 43045703, refAllele: 'C', altAllele: 'T', clinicalSignificance: 'Pathogenic', reviewStatus: 'criteria provided, multiple submitters, no conflicts', diseaseName: 'Hereditary breast and ovarian cancer syndrome', variantType: 'single nucleotide variant', origin: 'germline', details: 'c.5266dupC variant.' },
                 { gene: 'CFTR', variantId: 'rs1800093', clinvarId: 541, chromosome: '7', position: 117559585, refAllele: 'ATCT', altAllele: 'A', clinicalSignificance: 'Pathogenic', reviewStatus: 'reviewed by expert panel', diseaseName: 'Cystic fibrosis', variantType: 'deletion', origin: 'germline', details: 'deltaF508 variant.' },
                 { gene: 'APOE', variantId: 'rs429358', clinvarId: 175, chromosome: '19', position: 44908684, refAllele: 'T', altAllele: 'C', clinicalSignificance: 'Risk factor', reviewStatus: 'criteria provided, multiple submitters, no conflicts', diseaseName: 'Alzheimer disease 2|Hyperlipoproteinemia, type III', variantType: 'single nucleotide variant', origin: 'germline', details: 'APOE e4 allele.' },
                 { gene: 'Factor V', variantId: 'rs6025', clinvarId: 12197, chromosome: '1', position: 169519049, refAllele: 'G', altAllele: 'A', clinicalSignificance: 'Pathogenic', reviewStatus: 'reviewed by expert panel', diseaseName: 'Activated protein C resistance|Thrombophilia due to factor V Leiden', variantType: 'single nucleotide variant', origin: 'germline', details: 'Factor V Leiden variant.' },
                 { gene: 'HBB', variantId: 'HbS', clinvarId: 9, chromosome: '11', position: 5227002, refAllele: 'A', altAllele: 'T', clinicalSignificance: 'Pathogenic', reviewStatus: 'reviewed by expert panel', diseaseName: 'Sickle cell anemia', variantType: 'single nucleotide variant', origin: 'germline', details: 'Sickle cell anemia variant.' },
                 { gene: 'TP53', variantId: 1234567, clinvarId: 18380, chromosome: '17', position: 7675088, refAllele: 'C', altAllele: 'T', clinicalSignificance: 'Pathogenic', reviewStatus: 'reviewed by expert panel', diseaseName: 'Li-Fraumeni syndrome', variantType: 'single nucleotide variant', origin: 'germline', details: 'Example pathogenic TP53 variant.' }
            ];

            // --- Helper Functions (formatDisplayKey, sanitizeHTML, formatVariantDetails) ---
            // (Remain the same)
            function formatDisplayKey(key) { if (!key) return ''; if (key.toLowerCase() === 'variantid') return 'Variant ID'; if (key.toLowerCase() === 'clinvarid') return 'ClinVar ID'; if (key.toLowerCase() === 'clinicalsignificance') return 'Significance'; let fKey = key.charAt(0).toUpperCase() + key.slice(1); return fKey.replace(/([A-Z])/g, ' $1').trim(); }
            function sanitizeHTML(text) { if (typeof text !== 'string') { text = String(text); } return text.replace(/</g, '<').replace(/>/g, '>'); }
            function formatVariantDetails(data, actualMainKeys) { let dHtml = '<div class="child-details">'; let dl = ''; const lKeys = actualMainKeys.map(k=>k.toLowerCase()); for (const key in data) { if (!config.showMainKeysInChildRow && lKeys.includes(key.toLowerCase())) continue; if (key.startsWith('DT_RowId')) continue; const fKey = formatDisplayKey(key); const val = (data[key]!==null&&data[key]!==undefined&&data[key]!=='')?sanitizeHTML(data[key]):'N/A'; dl += `<dt>${fKey}:</dt><dd>${val}</dd>`; } if (dl) { dHtml += `<dl>${dl}</dl>`; } else { dHtml += `<div class="no-details">No additional details.</div>`; } dHtml += '</div>'; return dHtml; }


            // --- Function to generate <thead> content (Includes empty first <th>) ---
            function generateTableHeaders(keys) {
                const thead = $('#variantsTable thead'); thead.empty();
                let headerRow = '<tr><th></th>'; // For dt-control column
                keys.forEach(key => { headerRow += `<th>${formatDisplayKey(key)}</th>`; });
                headerRow += '<th>Genome Browser</th>'; headerRow += '</tr>'; thead.append(headerRow);
            }

            // --- Function to generate DataTables `columns` array (Includes dt-control column) ---
            function generateColumnDefs(keys) {
                const columnDefs = [
                    { // Manual Control Column definition matches DT example
                        className: 'dt-control', orderable: false, data: null,
                        defaultContent: '', // Relies on default CSS for indicator
                        width: '15px'
                    }
                ];
                // Data columns
                keys.forEach(key => {
                    const lowerKey = key.toLowerCase(); const columnDef = { data: key, title: formatDisplayKey(key) };
                    if (lowerKey === 'clinvarid') { columnDef.render = function (d, t) { if(t==='display'&&d){ const id=sanitizeHTML(d); return `<a href="https://www.ncbi.nlm.nih.gov/clinvar/variation/${id}/" target="_blank" rel="noopener noreferrer">${id}</a>`;} return d; }; }
                    else if (lowerKey === 'variantid') { columnDef.render = function (d, t) { if(t==='display'&&typeof d==='string'&&d.startsWith('rs')){ const id=sanitizeHTML(d); return `<a href="https://www.ncbi.nlm.nih.gov/snp/${id}" target="_blank" rel="noopener noreferrer">${id}</a>`;} return t==='display'?sanitizeHTML(d):d; }; }
                    else { columnDef.render = function (d, t) { return t === 'display' ? sanitizeHTML(d) : d; } }
                    columnDefs.push(columnDef);
                });
                // Genome Browser column
                columnDefs.push({ data: null, orderable: false, title: 'Genome Browser', className: 'genome-browser-col', width: '40px', render: function (data, type, row) { if (type === 'display') { const chr = row.chromosome; const posStr = row.position?String(row.position):null; const pos = posStr?posStr.split('-')[0]:null; if (chr && pos && config.genomeBrowserBaseUrl && /^\d+$/.test(pos)) { const encChr=encodeURIComponent(chr); const encPos=encodeURIComponent(pos); const encAssm=encodeURIComponent(config.genomeAssembly); const url = `${config.genomeBrowserBaseUrl}&assm=${encAssm}&chr=${encChr}&from=${encPos}&to=${encPos}`; return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="genome-browser-link" title="View ${sanitizeHTML(chr)}:${sanitizeHTML(pos)} on NCBI Genome Browser (${sanitizeHTML(config.genomeAssembly)})">🧬</a>`; } return '<span class="genome-browser-link na" title="Chromosome or position missing/invalid">N/A</span>'; } return null; } });
                return columnDefs;
            }

            // --- Function to Initialize DataTable (Manual controls) ---
            function initializeDataTable(tableData, columnDefs, actualMainKeys) {
                if ($.fn.dataTable.isDataTable('#variantsTable')) {
                    $('#variantsTable').DataTable().destroy();
                    $('#variantsTable tbody').empty();
                    $('#variantsTable thead').empty();
                }
                generateTableHeaders(actualMainKeys); // Regenerate headers

                const table = new DataTable('#variantsTable', {
                    data: tableData,
                    columns: columnDefs,
                    order: [[1, 'asc']],
                    layout: {
                        topStart: 'search',
                        topEnd: { buttons: ['copy', 'csv', 'excel', 'pdf', 'print', 'colvis'] },
                        bottomStart: 'info',
                        bottomEnd: 'paging'
                    },
                    paging: true, pageLength: 10, searching: true, info: true, autoWidth: false,
                    language: { searchPlaceholder: "Search variants...", search: "" }
                    // No 'responsive' option
                });

                // --- Simplified Manual Click Handler (based on DT Example) ---
                table.on('click', 'td.dt-control', function (e) {
                    // Use e.currentTarget instead of $(this) for slight efficiency
                    const td = e.currentTarget;
                    const tr = td.closest('tr');
                    // Ensure we get the row API object correctly
                    const row = table.row(tr);

                    if (!row || !row.data()) { console.error("Cannot get row data."); return; }

                    if (row.child.isShown()) {
                        // Row is already open - close it
                        row.child.hide();
                        // DataTables automatically removes the 'parent' class from <tr>
                    } else {
                        // Open this row
                        // Pass the row's data object to the formatting function
                        row.child(formatVariantDetails(row.data(), actualMainKeys)).show();
                        // DataTables automatically adds the 'parent' class to <tr>
                    }

                    // No need to manually toggle classes (like dt-hasChild or details)
                    // No need to manually set ARIA attributes unless specifically required for A11y pass
                });
                 // --- End Simplified Handler ---


                table.on( 'draw.dt', function () { /* console.log( 'Draw event' ); */ });
            } // End of initializeDataTable

            // --- Logic to Load Data and Initialize ---
            document.addEventListener('DOMContentLoaded', function() {
                const loader = document.getElementById('loader');
                loader.style.display = 'flex'; // Show loader

                console.log("DOMContentLoaded.");
                let dataPromise;
                if (config.useCsvData) { // Load CSV
                    console.log(`Loading CSV: ${config.csvFilePath}`);
                    dataPromise = fetch(config.csvFilePath)
                        .then(response => { if (!response.ok) { throw new Error(`Fetch failed: ${response.status} ${response.statusText}`); } console.log("CSV fetched."); return response.text(); })
                        .then(csvText => { console.log("Parsing CSV..."); return new Promise((resolve, reject) => { Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: true, complete: function(results) { if (results.errors && results.errors.length > 0) { console.warn("PapaParse errors:", results.errors); } if (!results.data || results.data.length === 0) { console.warn("CSV parsed, no data."); resolve([]); } else { console.log(`Parsed ${results.data.length} rows.`); resolve(results.data); } }, error: function(error) { reject(new Error(`PapaParse error: ${error.message}`)); } }); }); });
                } else { // Load JS Array
                    console.log("Loading JS array...");
                    dataPromise = Promise.resolve(JSON.parse(JSON.stringify(dataFromJs)));
                }

                // --- Process data ---
                dataPromise
                    .then(data => { // Data loaded
                        console.log("Data loaded.");
                        if (!data || data.length === 0) { console.warn("No data."); $('#variantsTable tbody').html('<tr><td colspan="100%" style="text-align: center; padding: 20px;">No data available.</td></tr>'); if ($('#variantsTable thead').is(':empty')) { $('#variantsTable thead').html('<tr><th>Info</th></tr>'); } return; }
                        // Determine Headers/Columns
                        const firstDataRow = data[0]; if (!firstDataRow) { throw new Error("Data invalid."); }
                        const actualKeysInFirstRow = Object.keys(firstDataRow);
                        const actualMainKeys = config.mainTableKeys.map(k=>actualKeysInFirstRow.find(ak=>ak.toLowerCase()===k.toLowerCase())).filter(Boolean);
                        if (actualMainKeys.length !== config.mainTableKeys.length) { console.warn(`Missing mainTableKeys.`); }
                        if (actualMainKeys.length === 0) { throw new Error("No mainTableKeys found."); }
                        const columnDefs = generateColumnDefs(actualMainKeys); // Includes dt-control
                        // Initialize table directly
                        try { initializeDataTable(data, columnDefs, actualMainKeys); }
                        catch (initError) { console.error('Init Error:', initError); /* Display error */ }
                    })
                    .catch(error => { // Handle errors
                        console.error('Init Error:', error);
                        $('#variantsTable tbody').html(`<tr><td colspan="100%" style="color: red; text-align: center; padding: 20px;"><strong>Error:</strong> ${error.message}. Check console.</td></tr>`);
                        if ($('#variantsTable thead').is(':empty')) { $('#variantsTable thead').html('<tr><th>Error</th></tr>'); }
                    })
                    .finally(() => {
                        loader.style.display = 'none'; // Hide loader
                    });
            }); // End DOMContentLoaded
        })(); // --- End of IIFE ---
    </script>

</body>
</html>
